<!DOCTYPE html>
<html>
<head>
	<meta name="viewport"content="width=device-width,initial-scale=1">
	<title>Neural Network</title>
	<style>
		#cvs{
			border:2px solid #000;
		}
		#cont{
			padding-left:5px;
		}
		button{
			margin-top:7px;
			padding:6px;
			font-size:14px;
		}
		table{
			border-collapse:collapse;
			table-layout:fixed;
			border-color:#eee;
			width:100%;
		}
		td{
			text-align:center;
			width:min(40px,calc(100%/9));
			height:40px;
		}
		#shwSamples{
			display:none;
		}
	</style>
</head>
<body>
	Draw a digit (0-9) and let the AI predict<br>
	<canvas id=cvs width=280 height=280></canvas><br>
	<div id=cont>
		<button onclick='ctx.fillStyle="#000";ctx.fillRect(0,0,280,280);scs.getContext("2d").fillRect(0,0,280,280);'>Clear</button><br>
		<button id=predictBtn>Predict</button><br>
		<button id=addBtn>New data</button><br>
		<input type=checkbox id=doTrain onchange="trainLoop()">Train</input>(<span id=epochs></span>)<br>
		<button id=updWaB>Export W & B</button>
	</div>
	<h2>Prediction:<span id=res>None</span></h2>
	<fieldset><table border=1><tr><td id=conf0></td><td id=conf1></td><td id=conf2></td><td id=conf3></td><td id=conf4></td><td id=conf5></td><td id=conf6></td><td id=conf7></td><td id=conf8></td><td id=conf9></td></tr></table></fieldset>
	<input type=checkbox onchange="shwSamples.style.display=this.checked?'block':'none';displaySample();">View Samples</input><br>
	<div id=shwSamples>
		<button onclick="splN=Math.max(splN-1,0);displaySample();"><</button>
		<button onclick="splN=Math.min(splN+1,trainingData.length-1);displaySample();">></button>
		<button onclick="displaySample(cvs);">Draw Sample</button>
		<div id=splLabel></div>
	</div>
	<canvas id=scs width=280 height=280></canvas>
	<script src="training_data.json"></script>
	<script src="wandb.json"></script>
	<script>
const ctx=cvs.getContext("2d");
ctx.fillStyle="#000";
ctx.fillRect(0,0,280,280);
let drawing=false;
const outputSize=10;
const learnRate=0.0001;
let ep=0,splN=0;
function randomMatrix(x,y){
	let scale=Math.sqrt(1/y);
	return Array.from({length:x},()=>Array.from({length:y},()=>(Math.random()*2-1)*scale));
}
let w1=randomMatrix(128,784);
let w2=randomMatrix(outputSize,128);
let b1=new Array(128).fill(0);
let b2=new Array(outputSize).fill(0);
let trainingData;
async function fetctdata(){
	let wandb=await fetch("wandb.json"),td=await fetch("training_data.json");
	let d=await wandb.json();
	trainingData=await td.json();
	w1=d.w1;
	w2=d.w2;
	b1=d.b1;
	b2=d.b2;
}
fetctdata();
// activation
function sigmoid(x){
	return 1/(1+Math.exp(-x));
}
function relu(x){
	return x>0?x:0;
}
function reluDeriv(x){
	return x>0?1:0;
}
function softmax(arr){
	let exp=arr.map(Math.exp);
	let sum=exp.reduce((a,b)=>a+b,0);
	return exp.map(v=>v/sum);
}
function matMul(vec,ws){
	return ws.map(x=>x.reduce((s,v,j)=>s+v*vec[j],0));
}
function predict(input){
	let hidden=matMul(input,w1).map((v,i)=>relu(v+b1[i]));
	let output=matMul(hidden,w2).map((v,i)=>v+b2[i]);
	return softmax(output);
}
// training
function train(input,label){
	let hidden=matMul(input,w1).map((v,i)=>relu(v+b1[i]));
	let output=softmax(matMul(hidden,w2).map((v,i)=>v+b2[i]));
	let target=new Array(outputSize).fill(0);
	target[+label]=1;
	let outputError=output.map((o,i)=>o-target[i]);
	let hiddenError=matMul(outputError,transpose(w2)).map((h,i)=>h*reluDeriv(hidden[i]));
	w2=adjustWeights(w2,outputError,hidden,learnRate);
	w1=adjustWeights(w1,hiddenError,input,learnRate);
	b2=b2.map((b,i)=>b-learnRate*outputError[i]);
	b1=b1.map((b,i)=>b-learnRate*hiddenError[i]);
}
function transpose(mat){
	return mat[0].map((_,i)=>mat.map(r=>r[i]));
}
function adjustWeights(w,e,l,lr){
	return w.map((r,i)=>r.map((w,j)=>w-lr*e[i]*l[j]));
}
function trainNetwork(){
	for(let i=0;i<trainingData.length;i++)train(trainingData[i].i,trainingData[i].l);
	ep++;
}
function trainLoop(){
	if(doTrain.checked){
		trainNetwork();
		setTimeout(trainLoop);
		if(ep%5<1)predictBtn.click();
	}
	epochs.innerText=ep+" iterations";
}
["touchstart","mousedown"].forEach(v=>cvs.addEventListener(v,e=>drawing=true));
["mouseup","mouseleave","touchend","touchcancel"].forEach((v,j)=>cvs.addEventListener(v,e=>drawing=false));
["touchmove","mousemove"].forEach((v,i)=>cvs.addEventListener(v,e=>draw(e,i)));
function draw(e,t){
	if(!drawing)return;
	let tg=t?e:e.targetTouches.length?e.targetTouches.item(0):e.touches.item(0);
	ctx.fillStyle="#fff";
	ctx.beginPath();
	ctx.arc(tg.pageX-cvs.offsetLeft,tg.pageY-cvs.offsetTop,10,0,Math.PI*2);
	ctx.fill();
}
function seeWhatISee(px,c=scs){
	let cx=c.getContext("2d");
	cx.fillStyle="#000";
	cx.fillRect(0,0,280,280);
	for(let i=0;i<784;i++){
		let x=i%28,y=i/28|0;
		let shade=Math.round(px[i]*255).toString(16).padStart(2,0);
		cx.fillStyle="#"+shade.repeat(3);
		cx.fillRect(x*10,y*10,(x+1)*10,(y+1)*10);
	}
}
function displaySample(c){
	let data=trainingData[splN];
	seeWhatISee(data.i,c);
	splLabel.innerText=data.l;
}
function training(act,inp){
	switch(act){
	case"add":
		let obj={l:inp[1],i:inp[0]};
		navigator.clipboard.writeText(JSON.stringify(obj));
		break;
	}
}
updWaB.onclick=function(){
	let link=document.createElement("a");
	link.href=URL.createObjectURL(new Blob([JSON.stringify({
		w1:w1,
		w2:w2,
		b1:b1,
		b2:b2
	})],{type:"text/plain"}));
	link.download="wandb.json";
	link.click();
	URL.revokeObjectURL(link.href);
}
predictBtn.onclick=_=>{
	let imgData=ctx.getImageData(0,0,280,280),gs=[];
	for(let y=0;y<28;y++)for(let x=0;x<28;x++){
		let b=imgData.data[11200*y+40*x]/255;
		gs.push(b);
	}
	let o=predict(gs);
	o.forEach((e,i)=>{
		let par=document.getElementById("conf"+i);
		let p=3;
		par.innerText=Math.round(e*10**(p+2))/10**p;
		par.style.opacity=(1+3*e)/4;
	});
	res.innerText=o.indexOf(Math.max(...o));
	seeWhatISee(gs);
}
addBtn.onclick=_=>{
	let label=prompt("data label?")||"";
	if(!label.trim())return;
	let conf=confirm("add data?");
	if(conf){
		let imgData=ctx.getImageData(0,0,280,280),gs=[];
		for(let y=0;y<28;y++)for(let x=0;x<28;x++){
			let b=imgData.data[11200*y+40*x]/255;
			gs.push(b);
		}
		training("add",[gs,label]);
	}
}
	</script>
</body>
</html>